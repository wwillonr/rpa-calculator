# AGENT MEMORY RAG

## SYSTEM STATUS
- **Workspace:** `rpa-calculator`
- **Environment:** Development (Local)
- **Last Update:** 2026-01-20

## PROJECT CONTEXT
- **Type:** ROI Calculator for RPA (React/Vite + Node.js?)
- **Current Issue:** Frontend not loading (404 on main.tsx, Manifest syntax error).

## DECISION LOG

### [2026-01-07] Initialization & Frontend Diagnosis
- **Context:** User reported white screen on localhost:5173. Error indicates browser looking for `main.tsx` while valid file is `main.jsx`.
- **Diagnosis:** Suspected Stale Service Worker (PWA) cache holding onto an old version of `index.html` referencing `main.tsx`.
- **Action:** 
    1. Initialized this RAG file.
    2. Planned to clear Vite cache (`.vite` folder).
    3. Instructed user to clear browser cache/hard reload.
    4. Executed cache cleanup: moved `frontend/node_modules/.vite` to `.vite_backup`.

### [2026-01-07] Fix Admin Settings Visibility
- **Context:** User logged in as "admin" but cannot see or access the configuration screen.
- **Analysis:** Investigating `Navbar.jsx` for button visibility logic and `Settings.jsx` or `AuthContext` for permission logic. `App.jsx` uses state-based routing (`currentView`).
- **Fix:** Modified `AuthContext.jsx` to include a fallback: if the user's email starts with "admin", automatically assign the 'admin' role, even if the Firestore document is missing or says 'user'. This bypasses potential DB issues during dev.

### [2026-01-07] Update History Table
- **Context:** User requested adding a "User Email" column and removing the ID display in the history table.
- **Action:**
    1.  Modified `backend/src/services/projectService.js` to enrich `listProjects` results with email data fetched from the `users` collection.
    2.  Updated `frontend/src/components/ProjectHistory.jsx` to add the "Usuário" column and remove the ID caption.

### [2026-01-12] Fix 400 Bad Request on ROI Calculation (Production)
- **Context:** User reported `400 Bad Request` on `/api/projects/calculate-roi` in Render. Local code uses `POST /api/projects`.
- **Diagnosis:** Version mismatch. Production is outdated.
- **Action:**
    1.  Enhanced `ROIWizard.jsx` to show detailed backend errors.
    2.  Validated local logic.
    3.  **Executed:** Deployed version `v1.0.41` via `release.js`.
    4.  **Note:** Created `.deploy_history.md`.
    5.  **Fix Iteration:** User reported persistent error. Identified missing `numSteps` in `ROIWizard.jsx` payload causing backend validation failure (400).
    6.  **Action:** Added `numSteps` to payload and updated `release.js` to bump backend version.

### [2026-01-20] Agentic Architect Session Start
- **Context:** User initialized "Agentic Architect" persona with strict environment rules (`/staging` vs `/prd`).
- **Analysis:**
    - Current structure: `root/backend`, `root/frontend`.
    - Requested structure: `root/staging`, `root/prd`.
    - **Discrepancy:** The physical directory structure does not match the prompt's "Ambiente Operacional".
- **Action:**
    - Updated RAG.
    - Will request user decision on directory restructuring vs logical mapping.

### [2026-01-20] Fix Frontend White Screen (Recurrence)
- **Context:** User reported white screen and 404 on `main.tsx` again.
- **Diagnosis:** Stale Service Worker cache persisting despite previous fixes.
- **Action:**
    1.  Updated `vite.config.js` to include `workbox: { cleanupOutdatedCaches: true, skipWaiting: true, clientsClaim: true }`.
    2.  Force deleted `frontend/node_modules/.vite`.
    3.  Instructed user to Hard Reload.

### [2026-01-21] Infrastructure Alignment - Directory Migration
- **Context:** User enforced strict environment structure (`/staging`, `/prd`) via prompt. Current structure is flat.
- **Analysis:** Need to migrate existing code (`backend`, `frontend`, docs) into `/staging` to comply with "Development occurs in /staging". `/prd` will be initialized as empty for now.
- **Action:**
    1.  Create `staging`, `prd`, `configs`.
    2.  Move app source and docs to `staging`.
    3.  Retain RAG and Deploy History in root.

### [2026-01-21] Fix Divergent Business Logic (Front/Back)
- **Context:** User reported two issues: 1) "Opex Exemption" selection reverting to default. 2) Complexity score showing different results in wizard vs report.
- **Analysis:**
    - `opex_exemption` was sent by frontend but ignored by backend `projectService`.
    - Frontend `Step3Complexity` applied +3 penalty for "No RPA License", but backend `calculationService` missed this rule.
- **Action:**
    - Updated `backend/src/services/projectService.js` to persist `opex_exemption`.
    - Updated `backend/src/services/calculationService.js` to include the +3 penalty logic, synchronizing scoring criteria.
    - **Follow-up:** Updated `frontend/src/components/steps/Step5Review.jsx` to include the same complexity penalty logic, ensuring the "Review" screen matches the calculation.
    - **Follow-up:** Updated `frontend/src/components/steps/Step5Review.jsx` to include the same complexity penalty logic, ensuring the "Review" screen matches the calculation.
    - **Follow-up:** Updated `frontend/src/components/steps/StepSustainability.jsx` to include the same complexity penalty logic, correcting the "Sustentação" proposal values.
    - **Follow-up:** Fixed `ResultsDashboard.jsx` to correctly interpret `opex_exemption` from backend (snake_case) vs frontend (camelCase) and fixed ROI calculation logic for 'não isento'.
    - **Follow-up:** Implemented a failsafe in `ROIWizard.jsx` to inject `opex_exemption` from local state into the results payload, bypassing potential stale backend processes that haven't picked up the persistence fix yet.

### [2026-02-10] Feature: Multi-Environment Selection
- **Context:** User requested ability to select multiple environments in Step 3 (Complexity).
- **Analysis:** Complexity score needed to reflect the sum of all selected environments to account for integration difficulty.
- **Action:**
    - Modified `ROIWizard.jsx` to handle `environment` as an array.
    - Updated `Step3Complexity.jsx` to use multi-select UI and sum points for preview.
    - Updated `calculationService.js` to iterate through the environment array and sum complexity points.

### [2026-02-10] UI Micro-Copy Update (Step 2)
- **Context:** User requested specific wording change for "Volume Mensal Médio" tooltip.
- **Action:** Updated tooltip in `Step2AsIsInputs.jsx` to: "Quantidade média de processos executados do inicio ao fim no mês."

### [2026-02-10] Enforce RPA License Usage (Step 3)
- **Context:** User requested removing the "No" option for RPA License in Step 3.
- **Action:** Modified `Step3Complexity.jsx` to remove the "No" option and default selected value to "Yes".
- **Follow-up:** Added `useEffect` to ensure `useRpaLicense` state is initialized to 'yes' if not present, enforcing the default selection on load.

### [2026-02-10] Step 1 UX Update: Read-Only OPEX Exemption
- **Context:** User requested the "Isenção de OPEX" field in Step 1 to be read-only.
- **Action:** Updated `Step1ProjectInfo.jsx` to set `readOnly={true}` on the `Select` component and hid the dropdown icon to reinforce the static nature of the field.

### [2026-02-10] Step 3 UX Update: Read-Only RPA License
- **Context:** User requested the "Uso de Licença RPA" field in Step 3 to be read-only.
- **Action:** Updated `Step3Complexity.jsx` to set `readOnly={true}` on the `TextField` (Select) component, removed interactivity, and hid the dropdown icon. Also defaulted the value to 'yes' in the render to match the read-only state.

### [2026-02-20] Step 1 UX Update: Remove OPEX Exemption
- **Context:** User requested the completely removal of the "Isenção de OPEX" field in Step 1 while maintaining its default value ("isento").
- **Action:** Removed `FormControl` and MUI Select references from `Step1ProjectInfo.jsx`. Verified that `ROIWizard.jsx` persists state internally `opexExemption: 'isento'`.

### [2026-02-20] Step 3 UX Update: Remove Helper Text (RPA License)
- **Context:** User requested the removal of the explicit explanatory text below the read-only field "Uso de Licença RPA".
- **Action:** Cleared the `helperText` property string on `Step3Complexity.jsx` to clean up the UI display, leaving the pre-configured value 'yes'.

### [2026-02-20] Step 3 UX Update: Convert RPA Select to TextField
- **Context:** User requested that the "Uso de Licença RPA" field in Step 3 be changed from a combobox (Select) to a standard read-only Textbox (TextField).
- **Action:** Removed `select` flag and `MenuItem` tag mappings in `Step3Complexity.jsx`. Redefined standard property `value` to precisely output static label string "Sim (Licença Comercial)".

### [2026-02-24] Feature: Annual Cost Estimate Tab in Settings
- **Context:** User requested a new tab in the Settings module titled "Estimativa de Custo Anual" to calculate RPA license costs based on annual totals and bot operation profiles (24h vs 12h), including dynamic recalculation and a "Memória de Cálculo" section.
- **Action:**
    1. Created `frontend/src/components/AnnualCostEstimateTab.jsx` encapsulating the UI, state, and mathematical logic derived from `estimativa_rpa_custo_minuto_contexto.md`. 
    2. Modified `frontend/src/components/Settings.jsx` to render the new component as the second tab, shifting "Administração de Usuários" to the third position.
    3. Maintained the application's design system using Material UI components (`Paper`, `Grid`, `Typography`, custom styled explanatory boxes).

### [2026-02-24] Fix CORS Configuration for Port 5174
- **Context:** `.deploy_history.md` for `v1.0.3` started that `localhost:5174` was added to CORS, but `server.js` and `.env` were missing this implementation.
- **Action:** 
    1. Added `http://localhost:5174` to `ALLOWED_ORIGINS` in `backend/.env`.
    2. Added `http://localhost:5174` to the fallback array in `backend/src/server.js`.

### [2026-02-24] Persistence: Annual Cost Estimate Settings
- **Context:** User requested the input limits and margin markup projections from the newly created `AnnualCostEstimateTab.jsx` to be saved directly to Firebase in the general settings configuration.
- **Action:**
    1. **Backend:** Updated `getSettings` payload structure in `backend/src/controllers/settingsController.js` to include `annual_cost_estimate` default definition structure.
    2. **Frontend:** Integrated `settingsService.getSettings()` mapped into a `useEffect` on `AnnualCostEstimateTab.jsx` initializing data with a loading overlay.
    3. **Frontend:** Programmed the "Salvar Configurações" button linked to a mapped payload comprising state inputs + calculated projections passed to `settingsService.updateSettings()`. Added asynchronous UI error handling components.

### [2026-02-24] UI Update: Annual Cost Estimate Settings
- **Context:** User requested to move the save button to the bottom of the page (aligning with general settings UX) and altering the success message.
- **Action:** 
    1. Adjusted `AnnualCostEstimateTab.jsx` by moving the save `Button` from the top inputs header to the absolute bottom of the container.
    2. Updated the success `feedback.message` to `"Configurações e parâmetros salvos com sucesso!"`.

### [2026-02-24] UI Update: Annual Cost Estimate Setup (Annual Metrics)
- **Context:** User requested the addition of "Custo Ano (Sem Margem)" and "Preço Ano (Com Margem)" to the individual Robot Profile summary cards and persistence on the backend.
- **Action:** 
    1. Added `costRobot24hYear`, `costRobot12hYear`, `priceRobot24hYear`, and `priceRobot12hYear` components bounded by a `<Grid>` mapping in the "Resumo por Perfil do Robô" table in `AnnualCostEstimateTab.jsx`.
    2. Updated the payload of `handleSave` adding the `costRobotxxhYear` values to the projection scope that is passed down to `settingsService.updateSettings`.

### [2026-02-24] Make Total Current Robots Editable
- **Context:** User wanted the "Total Atual de Robôs" field to be editable and persistent rather than strictly calculated from the sum of 12h/24h robot counts.
- **Action:**
    1. Transformed `totalCurrentRobots` into an independent state variable initialized to 51.
    2. Updated the display `<Typography>` to a `<TextField>` in `AnnualCostEstimateTab.jsx` to enable editing.
    3. Included `totalCurrentRobots` in the standard backend defaults and in the frontend `settingsService` mapping arrays.

### [2026-02-24] Revert Total Current Robots to Calculated Display
- **Context:** User immediately requested to revert the previous change, returning the "Total Atual de Robôs" field to a read-only sum of the 24h & 12h profiles.
- **Action:**
    1. Removed `totalCurrentRobots` from `AnnualCostEstimateTab.jsx` state space and Firebase interaction mappings.
    2. Restored `totalCurrentRobots = Number(robots24h) + Number(robots12h)` calculation.
    3. Replaced the `TextField` back to `<Typography>` and removed `totalCurrentRobots` from the backend's default parameter generation (`settingsController.js`).

### [2026-02-24] UI Update: Reorganize Layout of Annual Cost Estimate
- **Context:** User requested a layout restructure to pair calculation guides (memory boxes) closely with their related context data sets.
- **Action:**
    1. Divided the single large `<Box>` of "Memória de Cálculo" in `AnnualCostEstimateTab.jsx` into two separate right-sided `<Grid item md={6}>` columns.
    2. Paired "1. Capacidade em Minutos" and "2. Rateio Unitário" next to the "Métricas de Tempo (Rateio)" block.
    3. Paired "3. Custo por Robô no Mês" and "4. Modelo de Projeção" next to the "Projeção Anual" block.

### [2026-02-24] UI Update: Add Average Annual Metrics to Projections
- **Context:** User requested the inclusion of "Custo por Robô/Ano" and "Preço por Robô/Ano" specifically within the "Projeção Anual" section grid.
- **Action:**
    1. Extracted `avgPricePerRobotCurrentYear` by multiplying `avgCostPerRobotCurrentYear` by the `priceMultiplier`.
    2. Injected "Custo Médio por Robô/Ano" (`avgCostPerRobotCurrentYear`) and "Preço Médio por Robô/Ano" (`avgPricePerRobotCurrentYear`) at the bottom of the "Projeção Anual" block, separated by a `<Divider>`.

### [2026-02-24] UI Update: Tweak Projections Typography & Persistence
- **Context:** User requested formatting standardizations for grid elements in "Projeção Anual", asking to match "Total Estimado 'Bot-Mês' Ano" and "Média de Robôs no Ano" to the sizing of "Custo Projetado Ano", and "Preço Médio por Robô/Ano" to "Receita Projetada Ano". Furthermore, `avgPricePerRobotCurrentYear` needed persistence.
- **Action:**
    1. Adjusted typography for "Total Estimado 'Bot-Mês' Ano", "Média de Robôs no Ano", and "Custo Médio por Robô/Ano" to `variant="subtitle1"` and `fontWeight="bold"`.
    2. Adjusted typography for "Preço Médio por Robô/Ano" to `variant="h5"`, `fontWeight="bold"`, and `color="success.main"`.
    3. Added `avgPricePerRobotCurrentYear` to the `payload` emitted in `handleSave`.

### [2026-02-24] Sync License Cost to Settings Projection
- **Context:** Rather than asking for a raw manual input in "Custo da Licença (Proporcional)" in Step 3 of the ROI Calculator, it should fetch and lock in the "Preço Médio por Robô/Ano" calculated in the settings page.
- **Action:**
    1. Added `useEffect` in `Step3Complexity.jsx` to fetch `settingsService` and update `data.rpaLicenseCost` on mount to the value of `avgPricePerRobotCurrentYear` from the settings.
    2. Made the `<TextField>` for proportional license cost read-only (`InputProps={{ readOnly: true }}`).
    3. Updated the `helperText` explanation to redirect users to "Configurações > Estimativa de Custo Anual".
    4. Truncated the imported value to 2 decimal places (`rawPrice.toFixed(2)`).
### [2026-02-24] Fix 500 Error in calculateDevelopmentCost (Empty Team)
- **Context:** A payload submitted to `POST /api/projects` was failing with a 500 server error and throwing "Failed to create project".
- **Investigation:** Analyzed the Node application crash and discovered Firestore was rejecting the insert because `complexity_score.hours.totalHours` was literally `undefined`. Traced this back to `calculationService.js` in `calculateDevelopmentCost()` which returned a loose `0` primitive instead of `{cost: 0, hours: 0}` block when the Global `teamComposition` settings array was completely empty.
- **Action:**
    1. Replaced `return 0;` with `return { cost: 0, hours: 0 };` for the fallback state inside `calculateDevelopmentCost()`.
    2. Modified `projectService.js` catch block to persist mapping the inner underlying error string (`error.message`) upward, improving visibility for potential future debugging. The payload successfully saves now.

### [2026-02-24] Fix Missing TO-BE License Cost Propagation in Dashboard
- **Context:** The "Custo TO-BE (OPEX)" display inside the `ResultsDashboard.jsx` was calculating the final value properly but the text breakdown for `Licenças:` was always extracting out of the fixed default `infraCosts.rpa_license_annual` value instead of the correctly determined `rpaLicenseCost` (which handles step 3's proportional logic and the user inputted constraints).
- **Investigation:** While `calculationService.js` computed `rpaLicenseCost` and properly injected it into `totalToBeCost`, when it mapped the internal values outward into the JSON API response `results.costs.toBe`, it inadvertently mapped `licenseCost: infraCosts.rpa_license_annual,` natively instead of using the local memory variable `rpaLicenseCost,` mapped previously on line 290.
- **Action:** Swapped `infraCosts.rpa_license_annual` with `rpaLicenseCost` within the `costs: { toBe: { licenseCost: ... } }` object returned by `calculateFullROI` in `calculationService.js`.

### [2026-02-25] Architect Alignment: Update Tech Stack Documentation
- **Context:** Following the instructions in `.workflow.md` to update `.stack_tech.md` reflecting recent architectural modifications and new features from `.agent_memory_rag.md` and `.deploy_history.md`.
- **Action:**
    1. Updated `.stack_tech.md` to include CORS configurations for `localhost:5174`.
    2. Documented the role of `AnnualCostEstimateTab.jsx` inside the `Settings` panel and its direct persistence logic.
    3. Documented updates on `settingsController.js` and `calculationService.js` regarding the new default project margins and fallback structures.
- **Motivo:** Manter a documentação técnica atualizada com o estado arquitetural real da aplicação conforme solicitado em `.workflow.md`.

### [2026-02-25] UI Update: Remove Specific Help Text in Step 3
- **Context:** User requested to specifically remove the sentence "Para maiores detalhes, acesse Configurações > Estimativa de Custo Anual." from the `helperText` of the proportional RPA License Cost field in Step 3.
- **Action:** Removed the specified text and connection link inside `frontend/src/components/steps/Step3Complexity.jsx` keeping only the first descriptive sentence.
- **Motivo:** Limpar a interface a pedido do usuário, simplificando as instruções da etapa.

### [2026-02-25] UI Update: Standardize RPA License Cost Field Visuals
- **Context:** User requested to remove the dashed bounding box wrapping the proportional "Custo da Licença" field and its explanation text in Step 3, asking to standardize it with the matching "Uso de Licença RPA" text field styling.
- **Action:** Removed the `<Box>` element (`border: '1px dashed #ccc'`, styling) wrapping the conditional text field in `Step3Complexity.jsx`. Transferred spatial margins (`sx={{ mt: 2 }}`) directly to the `TextField` component and dropped `size="small"` to make its dimensions identical to the parent license usage field.
- **Motivo:** Homogeneizar a interface visual da etapa, removendo contornos desnecessários e igualando as proporções dos campos de acordo com a preferência do usuário.

### [2026-02-25] UI Update: Horizontal Layout for License Fields in Step 3
- **Context:** User requested that the "Uso de Licença RPA" and "Custo da Licença" fields be aligned horizontally instead of stacked vertically.
- **Action:** Split the conditional render in `frontend/src/components/steps/Step3Complexity.jsx`. Closed the `<Grid item xs={12} md={6}>` column exactly after the "Uso de Licença" input, and placed the dependent "Custo da Licença" inside a newly adjacent conditionally rendered `<Grid item xs={12} md={6}>`. Also mapped out the removal of the now decoupled spacer `sx={{ mt: 2 }}` from the inner field since the Grid container spacing automatically aligns it horizontally into the empty right column of the row.
- **Motivo:** Otimizar o layout usando o espaço horizontal vazio restante do grid e melhorar o fluxo visual, alinhando informações dependentes paralelamente.

### [2026-02-25] Security Update: Restrict Settings Routing to Admins
- **Context:** User requested that access to the "Configurações" routes be made exclusive to users holding the admin profile. While `Navbar.jsx` already hid the navigation button, the overarching route component could theoretically still be forced/rendered.
- **Action:** Extracted `isAdmin` boolean from the `useAuth()` hook inside `frontend/src/App.jsx`. Added a strict conditional trap inside `handleNavigate` to block setting `currentView` to 'settings' if `!isAdmin` (printing an error to console). Furthermore, strictly enforced rendering condition adding `&& isAdmin` to the `<Settings />` component call map.
- **Motivo:** Fechar a brecha de segurança de navegação forçada no Front-end (RBAC) isolando a área administrativa.