# AGENT MEMORY RAG

## SYSTEM STATUS
- **Workspace:** `rpa-calculator`
- **Environment:** Development (Local)
- **Last Update:** 2026-01-20

## PROJECT CONTEXT
- **Type:** ROI Calculator for RPA (React/Vite + Node.js?)
- **Current Issue:** Frontend not loading (404 on main.tsx, Manifest syntax error).

## DECISION LOG

### [2026-01-07] Initialization & Frontend Diagnosis
- **Context:** User reported white screen on localhost:5173. Error indicates browser looking for `main.tsx` while valid file is `main.jsx`.
- **Diagnosis:** Suspected Stale Service Worker (PWA) cache holding onto an old version of `index.html` referencing `main.tsx`.
- **Action:** 
    1. Initialized this RAG file.
    2. Planned to clear Vite cache (`.vite` folder).
    3. Instructed user to clear browser cache/hard reload.
    4. Executed cache cleanup: moved `frontend/node_modules/.vite` to `.vite_backup`.

### [2026-01-07] Fix Admin Settings Visibility
- **Context:** User logged in as "admin" but cannot see or access the configuration screen.
- **Analysis:** Investigating `Navbar.jsx` for button visibility logic and `Settings.jsx` or `AuthContext` for permission logic. `App.jsx` uses state-based routing (`currentView`).
- **Fix:** Modified `AuthContext.jsx` to include a fallback: if the user's email starts with "admin", automatically assign the 'admin' role, even if the Firestore document is missing or says 'user'. This bypasses potential DB issues during dev.

### [2026-01-07] Update History Table
- **Context:** User requested adding a "User Email" column and removing the ID display in the history table.
- **Action:**
    1.  Modified `backend/src/services/projectService.js` to enrich `listProjects` results with email data fetched from the `users` collection.
    2.  Updated `frontend/src/components/ProjectHistory.jsx` to add the "Usuário" column and remove the ID caption.

### [2026-01-12] Fix 400 Bad Request on ROI Calculation (Production)
- **Context:** User reported `400 Bad Request` on `/api/projects/calculate-roi` in Render. Local code uses `POST /api/projects`.
- **Diagnosis:** Version mismatch. Production is outdated.
- **Action:**
    1.  Enhanced `ROIWizard.jsx` to show detailed backend errors.
    2.  Validated local logic.
    3.  **Executed:** Deployed version `v1.0.41` via `release.js`.
    4.  **Note:** Created `.deploy_history.md`.
    5.  **Fix Iteration:** User reported persistent error. Identified missing `numSteps` in `ROIWizard.jsx` payload causing backend validation failure (400).
    6.  **Action:** Added `numSteps` to payload and updated `release.js` to bump backend version.

### [2026-01-20] Agentic Architect Session Start
- **Context:** User initialized "Agentic Architect" persona with strict environment rules (`/staging` vs `/prd`).
- **Analysis:**
    - Current structure: `root/backend`, `root/frontend`.
    - Requested structure: `root/staging`, `root/prd`.
    - **Discrepancy:** The physical directory structure does not match the prompt's "Ambiente Operacional".
- **Action:**
    - Updated RAG.
    - Will request user decision on directory restructuring vs logical mapping.

### [2026-01-20] Fix Frontend White Screen (Recurrence)
- **Context:** User reported white screen and 404 on `main.tsx` again.
- **Diagnosis:** Stale Service Worker cache persisting despite previous fixes.
- **Action:**
    1.  Updated `vite.config.js` to include `workbox: { cleanupOutdatedCaches: true, skipWaiting: true, clientsClaim: true }`.
    2.  Force deleted `frontend/node_modules/.vite`.
    3.  Instructed user to Hard Reload.

### [2026-01-21] Infrastructure Alignment - Directory Migration
- **Context:** User enforced strict environment structure (`/staging`, `/prd`) via prompt. Current structure is flat.
- **Analysis:** Need to migrate existing code (`backend`, `frontend`, docs) into `/staging` to comply with "Development occurs in /staging". `/prd` will be initialized as empty for now.
- **Action:**
    1.  Create `staging`, `prd`, `configs`.
    2.  Move app source and docs to `staging`.
    3.  Retain RAG and Deploy History in root.

### [2026-01-21] Fix Divergent Business Logic (Front/Back)
- **Context:** User reported two issues: 1) "Opex Exemption" selection reverting to default. 2) Complexity score showing different results in wizard vs report.
- **Analysis:**
    - `opex_exemption` was sent by frontend but ignored by backend `projectService`.
    - Frontend `Step3Complexity` applied +3 penalty for "No RPA License", but backend `calculationService` missed this rule.
- **Action:**
    - Updated `backend/src/services/projectService.js` to persist `opex_exemption`.
    - Updated `backend/src/services/calculationService.js` to include the +3 penalty logic, synchronizing scoring criteria.
    - **Follow-up:** Updated `frontend/src/components/steps/Step5Review.jsx` to include the same complexity penalty logic, ensuring the "Review" screen matches the calculation.
    - **Follow-up:** Updated `frontend/src/components/steps/Step5Review.jsx` to include the same complexity penalty logic, ensuring the "Review" screen matches the calculation.
    - **Follow-up:** Updated `frontend/src/components/steps/StepSustainability.jsx` to include the same complexity penalty logic, correcting the "Sustentação" proposal values.
    - **Follow-up:** Fixed `ResultsDashboard.jsx` to correctly interpret `opex_exemption` from backend (snake_case) vs frontend (camelCase) and fixed ROI calculation logic for 'não isento'.
    - **Follow-up:** Implemented a failsafe in `ROIWizard.jsx` to inject `opex_exemption` from local state into the results payload, bypassing potential stale backend processes that haven't picked up the persistence fix yet.

### [2026-02-10] Feature: Multi-Environment Selection
- **Context:** User requested ability to select multiple environments in Step 3 (Complexity).
- **Analysis:** Complexity score needed to reflect the sum of all selected environments to account for integration difficulty.
- **Action:**
    - Modified `ROIWizard.jsx` to handle `environment` as an array.
    - Updated `Step3Complexity.jsx` to use multi-select UI and sum points for preview.
    - Updated `calculationService.js` to iterate through the environment array and sum complexity points.

### [2026-02-10] UI Micro-Copy Update (Step 2)
- **Context:** User requested specific wording change for "Volume Mensal Médio" tooltip.
- **Action:** Updated tooltip in `Step2AsIsInputs.jsx` to: "Quantidade média de processos executados do inicio ao fim no mês."

### [2026-02-10] Enforce RPA License Usage (Step 3)
- **Context:** User requested removing the "No" option for RPA License in Step 3.
- **Action:** Modified `Step3Complexity.jsx` to remove the "No" option and default selected value to "Yes".
- **Follow-up:** Added `useEffect` to ensure `useRpaLicense` state is initialized to 'yes' if not present, enforcing the default selection on load.

### [2026-02-10] Step 1 UX Update: Read-Only OPEX Exemption
- **Context:** User requested the "Isenção de OPEX" field in Step 1 to be read-only.
- **Action:** Updated `Step1ProjectInfo.jsx` to set `readOnly={true}` on the `Select` component and hid the dropdown icon to reinforce the static nature of the field.

### [2026-02-10] Step 3 UX Update: Read-Only RPA License
- **Context:** User requested the "Uso de Licença RPA" field in Step 3 to be read-only.
- **Action:** Updated `Step3Complexity.jsx` to set `readOnly={true}` on the `TextField` (Select) component, removed interactivity, and hid the dropdown icon. Also defaulted the value to 'yes' in the render to match the read-only state.

### [2026-02-20] Step 1 UX Update: Remove OPEX Exemption
- **Context:** User requested the completely removal of the "Isenção de OPEX" field in Step 1 while maintaining its default value ("isento").
- **Action:** Removed `FormControl` and MUI Select references from `Step1ProjectInfo.jsx`. Verified that `ROIWizard.jsx` persists state internally `opexExemption: 'isento'`.

### [2026-02-20] Step 3 UX Update: Remove Helper Text (RPA License)
- **Context:** User requested the removal of the explicit explanatory text below the read-only field "Uso de Licença RPA".
- **Action:** Cleared the `helperText` property string on `Step3Complexity.jsx` to clean up the UI display, leaving the pre-configured value 'yes'.

### [2026-02-20] Step 3 UX Update: Convert RPA Select to TextField
- **Context:** User requested that the "Uso de Licença RPA" field in Step 3 be changed from a combobox (Select) to a standard read-only Textbox (TextField).
- **Action:** Removed `select` flag and `MenuItem` tag mappings in `Step3Complexity.jsx`. Redefined standard property `value` to precisely output static label string "Sim (Licença Comercial)".